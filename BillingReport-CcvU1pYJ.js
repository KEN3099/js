import{a as Z,r as m,q as ee,l as Ie,z as Ce,a9 as U,aa as l,o as p,c as o,e as w,u as s,N as r,ad as n,b as f,ab as A,F as te,a4 as ae,K as j}from"./@vue-C4NowhOt.js";import{u as ze}from"./vue-i18n-DLYs8-Ps.js";import{a as x}from"./axios-NIGUFBhG.js";import{d as H}from"./dayjs-CflfeGVC.js";import{_ as Ne}from"./index-CeZUq1ge.js";import{h as d,d as Se,f as De,C as Pe,F as Re,n as Me,a as Ue,I as Ae,S as Be,B as Fe,j as Le,T as Oe,o as qe,p as Te,g as Ve,q as je,r as He}from"./ant-design-vue-A2bDz-ar.js";import"./@intlify-ZcBRI--x.js";import"./pinia-9OtbBE5K.js";import"./vue-router-PaDTG1U4.js";import"./@ant-design-BGOLSkC9.js";import"./@ctrl-DOFZgDuz.js";import"./element-plus-Mh0yyZIL.js";import"./lodash-es-wgX17T5E.js";import"./@vueuse-BBvwCcyR.js";import"./@element-plus-DaL4F972.js";import"./@popperjs-DB1lLFnh.js";import"./async-validator-CRx4dHSJ.js";import"./memoize-one-BdPwpGay.js";import"./normalize-wheel-es-BQoi3Ox2.js";import"./@floating-ui-DnZj_KkR.js";import"./@babel-Bq4_u9L9.js";import"./resize-observer-polyfill-B1PUzC5B.js";import"./@emotion-BtrR-yrm.js";import"./stylis-DsJDcYJc.js";import"./scroll-into-view-if-needed-SxpMpKWN.js";import"./compute-scroll-into-view-1gs_hJI2.js";import"./vue-types-99Xd1yP8.js";import"./dom-align-CRCehRfe.js";import"./throttle-debounce-CUWDS_la.js";const $e={class:"form-fields"},Ye={class:"form-actions"},Ee=["onClick"],Ge={key:1,class:"action-link",disabled:""},Ke=["onClick"],We={key:1,class:"action-link",disabled:""},Qe=["onClick"],Je={key:1,class:"action-link",disabled:""},Xe=["title"],Ze=["src"],et={key:1,class:"pdf-loading"},tt={key:0,class:"audit-modal-content"},at={class:"audit-modal-footer"},lt={__name:"BillingReport",setup(ot){const{t:e}=ze(),u=Z({hostId:null,period:H(),pid:null,status:null}),le="/api/host/";x.defaults.baseURL=le;const B=m([]),_=m(!1),g=m(!1),v=Z({current:1,pageSize:10,total:0,showSizeChanger:!0,pageSizeOptions:["10","20","50","100"]}),h=m(!1),oe=ee(()=>[{label:e("common.all"),value:null},...$.value]),$=m([]),F=m(!1),se=ee(()=>[{title:"Host Name",dataIndex:"hostName",width:100},{title:"PID",dataIndex:"pid",width:100},{title:e("fields.host"),dataIndex:"billName",width:120},{title:e("fields.period"),dataIndex:"period",width:100},{title:e("fields.incomeAmount"),dataIndex:"grandTotal",width:100},{title:e("fields.status"),dataIndex:"status",width:100},{title:e("fields.createdAt"),dataIndex:"gentime",width:150},{title:e("fields.updatedAt"),dataIndex:"uptime",width:150},{title:e("fields.action"),dataIndex:"action",width:150,fixed:g.value?void 0:"right"}]),L=m(!1),k=m({}),R=m(!1),I=m(""),Y=()=>{I.value&&(window.URL.revokeObjectURL(I.value),I.value=""),R.value=!1,h.value=!1},ne=()=>{h.value=!h.value},z=m(!1),b=m(null),O=()=>{g.value=window.innerWidth<=768},E=a=>({0:e("status.pendingGenerate"),1:e("status.generated"),2:e("status.completed"),3:e("status.audited")})[a]||e("status.unknown"),G=a=>({0:"default",1:"processing",2:"success",3:"processing"})[a]||"default",ie=a=>a?H(a).format("YYYY-MM-DD HH:mm:ss"):"-",N=async()=>{try{_.value=!0;const a={page:v.current,size:v.pageSize,...u},t=await x.post("/admin/billReport/query",a);t.data.code==200?(B.value=t.data.data.records||t.data.data||[],v.total=t.data.data.total||0):d.error(t.data.message||"æŸ¥è¯¢å¤±è´¥")}catch(a){console.error("æŸ¥è¯¢å¤±è´¥:",a),d.error("æŸ¥è¯¢å¤±è´¥: "+a.message)}finally{_.value=!1}},re=async a=>{try{_.value=!0;const t=await x.get(`/admin/billReport/generate?billId=${a.billId}`);t.data.code==200?(I.value=t.data.data,R.value=!0,d.success("PDFåŠ è½½æˆåŠŸ")):d.error(t.data.message||"PDFåŠ è½½å¤±è´¥")}catch(t){console.error("è´¦å•é¢„è§ˆå¤±è´¥:",t),d.error("è´¦å•é¢„è§ˆå¤±è´¥: "+(t.response?.data?.message||t.message))}finally{_.value=!1}},de=async()=>{try{F.value=!0;const a=await x.get("/admin/host/getAllHostName");a.data.code==200?$.value=a.data.data.map(t=>({label:t.hostName,value:t.id})):d.error(a.data.message||"èŽ·å–æˆ¿ä¸œåˆ—è¡¨å¤±è´¥")}catch(a){console.error("èŽ·å–æˆ¿ä¸œåˆ—è¡¨å¤±è´¥:",a),d.error("èŽ·å–æˆ¿ä¸œåˆ—è¡¨å¤±è´¥: "+a.message)}finally{F.value=!1}},ue=()=>{if(!u.period){d.warning("è¯·é€‰æ‹©å¹´æœˆ");return}v.current=1,N()},ce=()=>{u.hostId=null,u.period=H(),u.pid=null,u.status=null,v.current=1,B.value=[],v.total=0},pe=a=>{v.current=a.current,v.pageSize=a.pageSize,N()},me=async a=>{if(a.status===2){d.warning("å·²ç»“ç®—ä¸èƒ½é‡å¤ç”Ÿæˆ");return}try{const t={billId:a.billId,hostId:a.hostId,period:a.period};_.value=!0;const C=await x.post("/admin/billReport/save",t);C.data.code==200?(await N(),d.success("è´¦å•ä¿å­˜æˆåŠŸ")):d.error(C.data.message||"è´¦å•ä¿å­˜å¤±è´¥")}catch(t){console.error("è´¦å•ä¿å­˜å¤±è´¥:",t),d.error("è´¦å•ä¿å­˜å¤±è´¥: "+(t.response?.data?.message||t.message))}finally{_.value=!1}},fe=a=>{b.value=a,z.value=!0},ve=async()=>{try{_.value=!0;const a=new FormData;a.append("id",b.value.billId);const t=await x.post("/admin/billReport/audit",a);t.data.code==200?(await N(),z.value=!1,d.success("å®¡æ ¸é€šè¿‡æˆåŠŸ")):d.error(t.data.message||"å®¡æ ¸å¤±è´¥")}catch(a){console.error("å®¡æ ¸å¤±è´¥:",a),d.error("å®¡æ ¸å¤±è´¥: "+(a.response?.data?.message||a.message))}finally{_.value=!1}},K=()=>{z.value=!1,b.value=null},_e=(a,t)=>t.label.toLowerCase().indexOf(a.toLowerCase())>=0,S=m([]),q=m(!1),ge=async()=>{try{q.value=!0;const a=await x.get("/admin/billReport/syncMonth");a.data.code==200?S.value=a.data.data.map(t=>({label:t,value:t})):d.error(a.data.message||"èŽ·å–å‘¨æœŸåˆ—è¡¨å¤±è´¥")}catch(a){console.error("èŽ·å–å‘¨æœŸåˆ—è¡¨å¤±è´¥:",a),d.error("èŽ·å–å‘¨æœŸåˆ—è¡¨å¤±è´¥: "+a.message)}finally{q.value=!1}};return Ie(async()=>{await ge(),S.value.length>0&&(u.period=S.value[0].value),O(),de(),S.value.length>0&&N(),window.addEventListener("resize",O)}),Ce(()=>{window.removeEventListener("resize",O)}),(a,t)=>{const C=Ue,D=Me,he=Ae,P=Be,M=Fe,be=Re,W=Pe,Q=Oe,T=Te,ye=qe,we=Le,xe=De,y=He,J=je,V=Ve,ke=Se;return p(),U(ke,{class:"billing-report-page"},{default:l(()=>[o(xe,{class:"content"},{default:l(()=>[o(W,{class:"query-card"},{default:l(()=>[o(be,{model:u,layout:"inline",class:"query-form"},{default:l(()=>[w("div",$e,[o(D,{label:"Host Name",class:"form-item"},{default:l(()=>[o(C,{value:u.hostId,"onUpdate:value":t[0]||(t[0]=i=>u.hostId=i),"show-search":"",placeholder:s(e)("common.select"),class:"responsive-select",style:{width:"150px"},options:oe.value,loading:F.value,"filter-option":_e,"get-popup-container":i=>i.parentNode},null,8,["value","placeholder","options","loading","get-popup-container"])]),_:1}),o(D,{label:s(e)("fields.period"),required:"",class:"form-item"},{default:l(()=>[o(C,{value:u.period,"onUpdate:value":t[1]||(t[1]=i=>u.period=i),placeholder:s(e)("fields.selectPeriodFrom"),class:"responsive-date-picker",style:{width:"150px"},options:S.value,loading:q.value,"get-popup-container":i=>i.parentNode},null,8,["value","placeholder","options","loading","get-popup-container"])]),_:1},8,["label"]),o(D,{label:"PID",class:"form-item"},{default:l(()=>[o(he,{value:u.pid,"onUpdate:value":t[2]||(t[2]=i=>u.pid=i),placeholder:s(e)("common.search")+" PID",class:"responsive-input",style:{width:"120px"}},null,8,["value","placeholder"])]),_:1}),o(D,{label:s(e)("fields.status"),class:"form-item"},{default:l(()=>[o(C,{value:u.status,"onUpdate:value":t[3]||(t[3]=i=>u.status=i),placeholder:s(e)("common.select"),class:"responsive-select",style:{width:"100px"},"get-popup-container":i=>i.parentNode},{default:l(()=>[o(P,{value:null},{default:l(()=>[r(n(s(e)("common.all")),1)]),_:1}),o(P,{value:0},{default:l(()=>[r(n(s(e)("status.pendingGenerate")),1)]),_:1}),o(P,{value:1},{default:l(()=>[r(n(s(e)("status.generated")),1)]),_:1}),o(P,{value:3},{default:l(()=>[r(n(s(e)("status.audited")),1)]),_:1}),o(P,{value:2},{default:l(()=>[r(n(s(e)("status.completed")),1)]),_:1})]),_:1},8,["value","placeholder","get-popup-container"])]),_:1},8,["label"])]),w("div",Ye,[o(D,{class:"action-buttons"},{default:l(()=>[o(M,{type:"primary",onClick:ue,class:"action-button"},{default:l(()=>[r(n(s(e)("common.search")),1)]),_:1}),o(M,{style:{"margin-left":"8px"},onClick:ce,class:"action-button"},{default:l(()=>[r(n(s(e)("common.reset")),1)]),_:1})]),_:1})])]),_:1},8,["model"])]),_:1}),o(W,{class:"table-card",bodyStyle:{padding:0}},{default:l(()=>[o(we,{dataSource:B.value,columns:se.value,loading:_.value,onChange:pe,rowKey:"id",scroll:g.value?{x:1e3}:void 0,size:g.value?"small":"default",pagination:g.value?{...v,simple:!0}:v},{bodyCell:l(({column:i,record:c})=>[i.dataIndex==="pid"?(p(),f(te,{key:0},[r(n(Array.isArray(c.pid)?c.pid.join(", "):c.pid||"-"),1)],64)):A("",!0),i.dataIndex==="status"?(p(),U(Q,{key:1,color:G(c.status),class:"status-tag"},{default:l(()=>[r(n(E(c.status)),1)]),_:2},1032,["color"])):i.dataIndex==="gentime"||i.dataIndex==="uptime"?(p(),f(te,{key:2},[r(n(ie(c[i.dataIndex])),1)],64)):i.dataIndex==="action"?(p(),U(ye,{key:3,size:g.value?"small":"middle",class:"action-space"},{default:l(()=>[o(T,{title:c.status===2?s(e)("status.settled"):""},{default:l(()=>[c.status!==2?(p(),f("a",{key:0,onClick:X=>me(c),class:"action-link"},n(s(e)("common.generate")),9,Ee)):(p(),f("a",Ge,n(s(e)("common.generate")),1))]),_:2},1032,["title"]),o(T,{title:c.status===0?s(e)("billing.generateBill"):""},{default:l(()=>[c.status!==0?(p(),f("a",{key:0,onClick:X=>re(c),class:"action-link"},n(s(e)("common.preview"))+"/ "+n(s(e)("common.download")),9,Ke)):(p(),f("a",We,n(s(e)("common.preview"))+"/ "+n(s(e)("common.download")),1))]),_:2},1032,["title"]),o(T,{title:c.status!==1?s(e)("billing.generateBill"):""},{default:l(()=>[c.status===1?(p(),f("a",{key:0,onClick:X=>fe(c),class:"action-link"},n(s(e)("common.audit")),9,Qe)):(p(),f("a",Je,n(s(e)("common.audit")),1))]),_:2},1032,["title"])]),_:2},1032,["size"])):A("",!0)]),_:1},8,["dataSource","columns","loading","scroll","size","pagination"])]),_:1})]),_:1}),o(V,{visible:L.value,"onUpdate:visible":t[4]||(t[4]=i=>L.value=i),title:s(e)("billing.viewBill"),onCancel:t[5]||(t[5]=i=>L.value=!1),footer:null,width:g.value?"95%":"600px"},{default:l(()=>[k.value?(p(),U(J,{key:0,bordered:"",size:"small",column:1},{default:l(()=>[o(y,{label:s(e)("fields.period")},{default:l(()=>[r(n(k.value.period),1)]),_:1},8,["label"]),o(y,{label:s(e)("fields.host")},{default:l(()=>[r(n(k.value.hostName),1)]),_:1},8,["label"]),o(y,{label:"PID"},{default:l(()=>[r(n(k.value.physicalRoomId),1)]),_:1}),o(y,{label:s(e)("fields.status")},{default:l(()=>[o(Q,{color:G(k.value.status),class:"status-tag"},{default:l(()=>[r(n(E(k.value.status)),1)]),_:1},8,["color"])]),_:1},8,["label"])]),_:1})):A("",!0)]),_:1},8,["visible","title","width"]),o(V,{visible:R.value,"onUpdate:visible":t[7]||(t[7]=i=>R.value=i),title:s(e)("common.preview"),onCancel:Y,footer:null,width:g.value?"95%":h.value?"100%":"80%",wrapClassName:h.value?"pdf-preview-modal fullscreen":"pdf-preview-modal",style:ae(h.value?{position:"fixed",top:0,left:0,width:"100%",height:"100%",margin:0,padding:0}:{}),closable:!1},{default:l(()=>[w("div",{style:{display:"flex","align-items":"center",position:"absolute",right:"20px",top:"15px","z-index":"1000"},onClick:t[6]||(t[6]=j(()=>{},["stop"]))},[w("button",{onClick:j(ne,["stop"]),style:{"margin-right":"15px",background:"#1890ff",border:"none",cursor:"pointer",color:"white","font-size":"16px",width:"32px",height:"32px","border-radius":"4px",display:"flex","align-items":"center","justify-content":"center","font-weight":"bold",outline:"none"},title:h.value?s(e)("fullscreen.exit"):s(e)("fullscreen.enter")},n(h.value?"ðŸ——":"â›¶"),9,Xe),w("span",{onClick:j(Y,["stop"]),style:{cursor:"pointer","font-size":"32px",color:"#000000",display:"flex","align-items":"center","justify-content":"center",width:"32px",height:"32px",outline:"none","box-shadow":"none"}},"Ã—")]),w("div",{class:"pdf-preview-container",style:ae(h.value?{height:"calc(100vh - 40px)"}:{height:"70vh"})},[I.value?(p(),f("iframe",{key:0,src:I.value,class:"pdf-iframe",frameborder:"0"},null,8,Ze)):(p(),f("div",et," PDFåŠ è½½ä¸­... "))],4)]),_:1},8,["visible","title","width","wrapClassName","style"]),o(V,{visible:z.value,"onUpdate:visible":t[8]||(t[8]=i=>z.value=i),title:s(e)("common.audit"),onCancel:K,footer:null,width:g.value?"95%":"400px"},{default:l(()=>[b.value?(p(),f("div",tt,[w("p",null,n(s(e)("common.confirm")),1),o(J,{bordered:"",size:"small",column:1},{default:l(()=>[o(y,{label:s(e)("fields.host")},{default:l(()=>[r(n(b.value.hostName),1)]),_:1},8,["label"]),o(y,{label:s(e)("fields.billName")},{default:l(()=>[r(n(b.value.billName),1)]),_:1},8,["label"]),o(y,{label:s(e)("fields.period")},{default:l(()=>[r(n(b.value.period),1)]),_:1},8,["label"]),o(y,{label:s(e)("fields.incomeAmount")},{default:l(()=>[r(n(b.value.grandTotal),1)]),_:1},8,["label"])]),_:1}),w("div",at,[o(M,{onClick:K,class:"audit-cancel-button"},{default:l(()=>[r(n(s(e)("common.cancel")),1)]),_:1}),o(M,{type:"primary",onClick:ve,class:"audit-confirm-button"},{default:l(()=>[r(n(s(e)("common.ok")),1)]),_:1})])])):A("",!0)]),_:1},8,["visible","title","width"])]),_:1})}}},At=Ne(lt,[["__scopeId","data-v-66ffd152"]]);export{At as default};
