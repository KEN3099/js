import{a as F}from"./axios-NIGUFBhG.js";import{d as f}from"./dayjs-CflfeGVC.js";import{_ as R}from"./index-CeZUq1ge.js";import{d as V,f as j,C as $,B as z,u as A,j as T,I as L,D as G,h as _}from"./ant-design-vue-A2bDz-ar.js";import{r as q,q as H,a9 as x,aa as u,o as y,c as m,e as b,N as I,ab as J}from"./@vue-C4NowhOt.js";import"./pinia-9OtbBE5K.js";import"./vue-router-PaDTG1U4.js";import"./vue-i18n-DLYs8-Ps.js";import"./@intlify-ZcBRI--x.js";import"./@ant-design-BGOLSkC9.js";import"./@ctrl-DOFZgDuz.js";import"./element-plus-Mh0yyZIL.js";import"./lodash-es-wgX17T5E.js";import"./@vueuse-BBvwCcyR.js";import"./@element-plus-DaL4F972.js";import"./@popperjs-DB1lLFnh.js";import"./async-validator-CRx4dHSJ.js";import"./memoize-one-BdPwpGay.js";import"./normalize-wheel-es-BQoi3Ox2.js";import"./@floating-ui-DnZj_KkR.js";import"./@babel-Bq4_u9L9.js";import"./resize-observer-polyfill-B1PUzC5B.js";import"./@emotion-BtrR-yrm.js";import"./stylis-DsJDcYJc.js";import"./scroll-into-view-if-needed-SxpMpKWN.js";import"./compute-scroll-into-view-1gs_hJI2.js";import"./vue-types-99Xd1yP8.js";import"./dom-align-CRCehRfe.js";import"./throttle-debounce-CUWDS_la.js";const O={style:{"margin-bottom":"12px",display:"flex",gap:"8px","flex-wrap":"wrap"}},Q=["colspan"],W={colspan:"2"},X={__name:"SettlementExpenses",setup(Z){const c=q([]);let k=1;const g=q(!1),h=[{title:"PID",dataIndex:"pid",width:100},{title:"代缴项目",dataIndex:"item",width:140},{title:"开始日期",dataIndex:"startDate",width:140},{title:"结束日期",dataIndex:"endDate",width:140},{title:"代缴数量",dataIndex:"quantity",width:120},{title:"代缴单价",dataIndex:"unitPrice",width:120},{title:"代缴金额",dataIndex:"amount",width:120},{title:"银行手续费",dataIndex:"bankFee",width:120},{title:"小计",dataIndex:"subtotal",width:120},{title:"备注",dataIndex:"remark",width:180},{title:"操作",dataIndex:"action",width:100}],P=()=>{c.value.push({_rowKey:`exp_${k++}`,pid:"",item:"",summary:"",startDate:null,endDate:null,quantity:"",unitPrice:"",amount:"",bankFee:"",subtotal:"",remark:""})},U=a=>{c.value.splice(a,1)},Y=(a,t,s)=>{let o=s.target.value.replace(/[^0-9]/g,"");a[t]=o,w(a)},C=(a,t,s)=>{let o=s.target.value.replace(/[^0-9.]/g,"");const r=o.split(".");r.length>2&&(o=r[0]+"."+r.slice(1).join("")),a[t]=o,(t==="unitPrice"||t==="bankFee")&&w(a)},w=a=>{const t=parseFloat(a.quantity)||0,s=parseFloat(a.unitPrice)||0,p=parseFloat(a.bankFee)||0,o=t*s;a.amount=o.toFixed(2);const r=o+p;a.subtotal=r.toFixed(2)},D=H(()=>c.value.reduce((t,s)=>t+(parseFloat(s.subtotal)||0),0).toFixed(2)),E=a=>a.map(t=>({pid:t.pid,item:t.item,summary:t.summary,startDate:t.startDate?f(t.startDate).format("YYYY-MM-DD"):null,endDate:t.endDate?f(t.endDate).format("YYYY-MM-DD"):null,quantity:t.quantity,unitPrice:t.unitPrice,amount:t.amount,bankFee:t.bankFee,subtotal:t.subtotal,remark:t.remark})),S=async()=>{try{if(c.value.length===0){_.warning("请先新增至少一行");return}g.value=!0;const a=E(c.value),t=await F.post("/admin/settlementReport/saveExpenses",a);t.data&&t.data.code===200?_.success("保存成功"):_.error(t.data?.message||"保存失败")}catch(a){_.error("保存失败: "+(a.response?.data?.message||a.message))}finally{g.value=!1}},M=()=>!0,N=async a=>{const{file:t,onSuccess:s,onError:p,onProgress:o}=a,r=new FormData;r.append("file",t);try{const i=await F.post("/admin/settlementReport/uploadExcel",r,{headers:{"Content-Type":"multipart/form-data"},onUploadProgress:v=>{const n=Math.round(v.loaded*100/(v.total||1));o({percent:n},t)}});if(i.data&&i.data.code===200){const v=Array.isArray(i.data.data)?i.data.data:[];c.value=v.map(n=>({_rowKey:`exp_${k++}`,pid:n.pid??"",item:n.item??"",summary:n.summary??"",startDate:n.startDate?f(n.startDate):null,endDate:n.endDate?f(n.endDate):null,quantity:n.quantity??"",unitPrice:n.unitPrice??"",amount:n.amount??"",bankFee:n.bankFee??"",subtotal:n.subtotal??"",remark:n.remark??""})),s(i.data,t),_.success("导入成功")}else p(new Error(i.data?.message||"导入失败")),_.error(i.data?.message||"导入失败")}catch(i){p(i),_.error("导入失败: "+(i.response?.data?.message||i.message))}};return(a,t)=>{const s=z,p=A,o=L,r=G,i=T,v=$,n=j,B=V;return y(),x(B,{class:"billing-report-page"},{default:u(()=>[m(n,{class:"content"},{default:u(()=>[m(v,{class:"table-card"},{title:u(()=>[I(" 代缴项目维护 ")]),default:u(()=>[b("div",O,[m(s,{type:"primary",onClick:P},{default:u(()=>[I("新增行")]),_:1}),m(p,{"show-upload-list":!1,"before-upload":M,customRequest:N},{default:u(()=>[m(s,null,{default:u(()=>[I("批量导入 Excel")]),_:1})]),_:1}),m(s,{type:"primary",loading:g.value,onClick:S},{default:u(()=>[I("保存")]),_:1},8,["loading"])]),m(i,{dataSource:c.value,columns:h,rowKey:"_rowKey",pagination:!1,size:"small",scroll:{x:1300}},{bodyCell:u(({column:e,record:d,index:K})=>[["pid","item","summary","remark"].includes(e.dataIndex)?(y(),x(o,{key:0,value:d[e.dataIndex],"onUpdate:value":l=>d[e.dataIndex]=l},null,8,["value","onUpdate:value"])):e.dataIndex==="quantity"?(y(),x(o,{key:1,value:d.quantity,"onUpdate:value":l=>d.quantity=l,onInput:l=>Y(d,"quantity",l)},null,8,["value","onUpdate:value","onInput"])):e.dataIndex==="unitPrice"||e.dataIndex==="bankFee"?(y(),x(o,{key:2,value:d[e.dataIndex],"onUpdate:value":l=>d[e.dataIndex]=l,onInput:l=>C(d,e.dataIndex,l)},null,8,["value","onUpdate:value","onInput"])):e.dataIndex==="amount"||e.dataIndex==="subtotal"?(y(),x(o,{key:3,value:d[e.dataIndex],"onUpdate:value":l=>d[e.dataIndex]=l,disabled:""},null,8,["value","onUpdate:value"])):e.dataIndex==="startDate"||e.dataIndex==="endDate"?(y(),x(r,{key:4,value:d[e.dataIndex],"onUpdate:value":l=>d[e.dataIndex]=l,format:"YYYY-MM-DD",style:{width:"100%"}},null,8,["value","onUpdate:value"])):e.dataIndex==="action"?(y(),x(s,{key:5,type:"link",danger:"",onClick:l=>U(K)},{default:u(()=>[I("删除")]),_:2},1032,["onClick"])):J("",!0)]),footer:u(()=>[b("tr",null,[b("td",{colspan:h.length-2,style:{"text-align":"right","font-weight":"bold"}},"本期扣除金额：",8,Q),b("td",W,[m(o,{value:D.value,"onUpdate:value":t[0]||(t[0]=e=>D.value=e),disabled:""},null,8,["value"])])])]),_:1},8,["dataSource"])]),_:1})]),_:1})]),_:1})}}},Ut=R(X,[["__scopeId","data-v-b775dd62"]]);export{Ut as default};
