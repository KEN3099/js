import{a as k}from"./axios-NIGUFBhG.js";import{d as Ie}from"./dayjs-CflfeGVC.js";import{u as Ce}from"./vue-i18n-DLYs8-Ps.js";import{_ as qe}from"./index-CeZUq1ge.js";import{h as r,d as Ee,f as Me,C as Ue,F as Pe,n as Se,I as ze,B as Le,j as Ye,o as Re,s as Oe,g as Be,i as Ne,l as Ve,a as je,D as Te,y as $e,w as We,u as Qe}from"./ant-design-vue-A2bDz-ar.js";import{a6 as W}from"./@ant-design-BGOLSkC9.js";import{r as u,a as Q,q as Ae,m as Ke,l as Ge,z as He,a9 as se,aa as s,o as I,c as l,e as v,u as n,N as _,ad as p,b as P,ab as A,F as ne,ag as Je}from"./@vue-C4NowhOt.js";import"./@intlify-ZcBRI--x.js";import"./pinia-9OtbBE5K.js";import"./vue-router-PaDTG1U4.js";import"./element-plus-Mh0yyZIL.js";import"./lodash-es-wgX17T5E.js";import"./@vueuse-BBvwCcyR.js";import"./@element-plus-DaL4F972.js";import"./@popperjs-DB1lLFnh.js";import"./@ctrl-DOFZgDuz.js";import"./async-validator-CRx4dHSJ.js";import"./memoize-one-BdPwpGay.js";import"./normalize-wheel-es-BQoi3Ox2.js";import"./@floating-ui-DnZj_KkR.js";import"./@babel-Bq4_u9L9.js";import"./resize-observer-polyfill-B1PUzC5B.js";import"./@emotion-BtrR-yrm.js";import"./stylis-DsJDcYJc.js";import"./scroll-into-view-if-needed-SxpMpKWN.js";import"./compute-scroll-into-view-1gs_hJI2.js";import"./vue-types-99Xd1yP8.js";import"./dom-align-CRCehRfe.js";import"./throttle-debounce-CUWDS_la.js";const Xe={class:"form-fields"},Ze={class:"form-actions"},ea=["onClick"],aa={class:"action-link"},ta={key:0,class:"files-preview"},la={class:"file-info"},sa={key:0,class:"image-preview"},na=["src","alt"],oa={class:"import-container"},ia={class:"import-tips"},ra={class:"modal-footer"},da={__name:"Expenses",setup(ua){const{t:a}=Ce(),K="/api/host/";k.defaults.baseURL=K;const S=u(),F=Q({pid:null,startDate:null,endDate:null}),G=u([]),R=u(!1),x=u(!1),b=Q({current:1,pageSize:10,total:0,showSizeChanger:!0,pageSizeOptions:["10","20","50","100"]}),H=u([]),oe=u([]),O=u(!1),ie=Ae(()=>{const t=[{title:a("expenses.pid"),dataIndex:"pid",width:100},{title:a("expenses.item"),dataIndex:"item",width:150},{title:a("time.startDate"),dataIndex:"startDate",width:120},{title:a("time.endDate"),dataIndex:"endDate",width:120},{title:a("expenses.quantity"),dataIndex:"quantity",width:100},{title:a("expenses.unitPrice"),dataIndex:"unitPrice",width:100},{title:a("expenses.amount"),dataIndex:"amount",width:100},{title:a("expenses.bankFee"),dataIndex:"bankFee",width:100},{title:a("expenses.subtotal"),dataIndex:"subtotal",width:100},{title:a("expenses.actions"),dataIndex:"action",width:120,fixed:x.value?void 0:"right"}];return x.value?t.filter(e=>e.dataIndex==="pid"||e.dataIndex==="item"||e.dataIndex==="amount"||e.dataIndex==="action").map(e=>e.dataIndex==="pid"?{...e,width:80}:e.dataIndex==="item"?{...e,width:100}:e.dataIndex==="amount"?{...e,width:80}:e.dataIndex==="action"?{...e,width:80}:e):t}),C=u(!1),B=u(!1),g=u(!1),z=u(null),o=Q({pid:void 0,item:void 0,summary:"",startDate:null,endDate:null,quantity:void 0,unitPrice:void 0,amount:void 0,bankFee:void 0,subtotal:void 0,remark:""}),re=u([{label:"固定資産税",value:"固定資産税"},{label:"管理修繕費",value:"管理修繕費"},{label:"不動産取得税",value:"不動産取得税"},{label:"逾期款項代繳",value:"逾期款項代繳"},{label:"町會費",value:"町會費"},{label:"保險費用",value:"保險費用"},{label:"代辨费用",value:"代辨费用"},{label:"牌照使用费",value:"牌照使用费"},{label:"牌照辦理費用",value:"牌照辦理費用"},{label:"消防點檢費用",value:"消防點檢費用"},{label:"摄影費用",value:"摄影費用"},{label:"採購費用",value:"採購費用"},{label:"軟装相關費用",value:"軟装相關費用"},{label:"維修費用",value:"維修費用"},{label:"解約费用",value:"解約费用"},{label:"預存費用",value:"預存費用"},{label:"調整费用",value:"調整费用"}]),h=u([]),y=u([]),q=u(!1),N=u(!1),J=(t,e)=>e.label.toLowerCase().indexOf(t.toLowerCase())>=0;Ke(()=>[o.quantity,o.unitPrice,o.bankFee],()=>{o.quantity!==void 0&&o.unitPrice!==void 0?o.amount=parseFloat((o.quantity*o.unitPrice).toFixed(2)):o.amount=void 0,o.amount!==void 0&&o.bankFee!==void 0?o.subtotal=parseFloat((o.amount+o.bankFee).toFixed(2)):o.amount!==void 0?o.subtotal=o.amount:o.subtotal=void 0});const V=()=>{x.value=window.innerWidth<=768},j=async()=>{try{O.value=!0;const t=await k.get("/admin/settlementReport/getPidList");if(t.data.code==200){const e=t.data.data.map(c=>({label:c.pid,value:c.id}));H.value=e,oe.value=e}else r.error(t.data.message||a("common.queryFailed"))}catch(t){console.error("获取PID列表失败:",t),r.error(a("common.queryFailed")+": "+t.message)}finally{O.value=!1}},D=async()=>{try{R.value=!0;const t={page:b.current,size:b.pageSize,...F},e=await k.post("/admin/settlementReport/queryExpensesList",t);e.data.code==200?(G.value=e.data.data.records||e.data.data||[],b.total=e.data.data.total||0):r.error(e.data.message||a("common.queryFailed"))}catch(t){console.error("查询失败:",t),r.error(a("common.queryFailed")+": "+t.message)}finally{R.value=!1}},de=()=>{b.current=1,D()},ue=()=>{F.pid=void 0,F.startDate=null,F.endDate=null,b.current=1,D()},pe=t=>{b.current=t.current,b.pageSize=t.pageSize,D()},ce=()=>{g.value=!1,z.value=null,Object.keys(o).forEach(t=>{o[t]=t==="quantity"||t==="unitPrice"||t==="amount"||t==="bankFee"||t==="subtotal"?void 0:""}),h.value=[],y.value=[],C.value=!0,S.value?.clearValidate(),j()},me=t=>{g.value=!0,z.value=t.id,Object.keys(o).forEach(e=>{o[e]=t[e]!==null&&t[e]!==void 0?t[e]:e==="quantity"||e==="unitPrice"||e==="amount"||e==="bankFee"||e==="subtotal"||e==="pid"?void 0:""}),t.attachment?y.value=t.files||[]:y.value=[],h.value=[],C.value=!0,S.value?.clearValidate(),j()},ve=async t=>{try{const e=await k.post("/admin/settlementReport/deleteExpense",{id:t.id});e.data.code==200?(r.success(a("success.deleteSuccess")),D()):r.error(e.data.message||a("error.deleteFailed"))}catch(e){console.error("删除失败:",e),r.error(a("error.deleteFailed")+": "+e.message)}},fe=async()=>{try{await S.value.validateFields(),B.value=!0;const t={...o};g.value&&z.value&&(t.id=z.value),y.value.length>0&&(t.attachment=y.value.map(c=>c.uuid).join(","));const e=await k.post("/admin/settlementReport/saveExpenses",t);e.data.code==200?(r.success(g.value?a("success.updateSuccess"):a("success.createSuccess")),C.value=!1,D()):r.error(e.data.message||(g.value?a("error.updateFailed"):a("error.createFailed")))}catch(t){console.error(g.value?"编辑失败:":"新增失败:",t),t.errorFields||r.error(g.value?a("error.updateFailed")+": "+t.message:a("error.createFailed")+": "+t.message)}finally{B.value=!1}},_e=()=>{q.value=!0,h.value=[]},xe=t=>t.type==="application/vnd.ms-excel"||t.type==="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"||t.name.endsWith(".xlsx")||t.name.endsWith(".xls")?t.size/1024/1024<10?!0:(r.error(a("expenses.fileSizeExceed")),!1):(r.error(a("expenses.onlyExcelFiles")),!1),be=t=>{const e=t.size/1024/1024<2;return e||r.error(a("expenses.fileSizeExceed2M")),e},X=async t=>{const{file:e,onSuccess:c,onError:d,onProgress:m}=t;if(e.type==="application/vnd.ms-excel"||e.type==="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"||e.name.endsWith(".xlsx")||e.name.endsWith(".xls"))h.value=[e],c();else{const M=new FormData;M.append("file",e);try{const f=await k.post("/admin/settlementReport/upload",M,{headers:{"Content-Type":"multipart/form-data"},onUploadProgress:L=>{const $=Math.round(L.loaded*100/L.total);m({percent:$},e)}});f.data.code==200?(y.value.push(f.data.data),c(f.data,e),r.success(a("expenses.uploadSuccess"))):(d(new Error(f.data.message||a("expenses.uploadFailed"))),r.error(f.data.message||a("expenses.uploadFailed")))}catch(f){d(f),r.error(a("expenses.uploadFailed")+": "+(f.response?.data?.message||f.message))}}},ge=t=>{y.value.splice(t,1)},he=t=>{const e=["jpg","jpeg","png","gif","bmp","webp"],c=t.split(".").pop().toLowerCase();return e.includes(c)},ye=async()=>{if(h.value.length===0){r.warning(a("expenses.selectFileFirst"));return}try{N.value=!0;const t=new FormData;t.append("file",h.value[0]);const e=await k.post("/admin/settlementReport/uploadExcel",t,{headers:{"Content-Type":"multipart/form-data"}});e.data.code==200?(r.success(a("expenses.importSuccess")),q.value=!1,D()):r.error(e.data.message||a("expenses.importFailed"))}catch(t){console.error("导入失败:",t),r.error(a("expenses.importFailed")+": "+(t.response?.data?.message||t.message))}finally{N.value=!1}},we=()=>{window.open(K+"/template.xlsx","_blank")};return Ge(()=>{V(),D(),j(),window.addEventListener("resize",V)}),He(()=>{window.removeEventListener("resize",V)}),(t,e)=>{const c=ze,d=Se,m=Le,T=Pe,M=Ue,f=Oe,L=Re,$=Ye,Fe=Me,Z=je,w=Ve,Y=Ne,ee=Te,U=$e,De=We,ae=Qe,te=Be,ke=Ee;return I(),se(ke,{class:"expenses-management-page"},{default:s(()=>[l(Fe,{class:"content"},{default:s(()=>[l(M,{class:"query-card"},{default:s(()=>[l(T,{model:F,layout:"inline",class:"query-form"},{default:s(()=>[v("div",Xe,[l(d,{label:n(a)("expenses.pid"),class:"form-item"},{default:s(()=>[l(c,{value:F.pid,"onUpdate:value":e[0]||(e[0]=i=>F.pid=i),placeholder:n(a)("expenses.enterPid"),class:"responsive-input",style:{width:"150px"}},null,8,["value","placeholder"])]),_:1},8,["label"])]),v("div",Ze,[l(d,{class:"action-buttons"},{default:s(()=>[l(m,{type:"primary",onClick:de,class:"action-button"},{default:s(()=>[_(p(n(a)("common.search")),1)]),_:1}),l(m,{style:{"margin-left":"8px"},onClick:ue,class:"action-button"},{default:s(()=>[_(p(n(a)("common.reset")),1)]),_:1}),l(m,{style:{"margin-left":"8px"},type:"primary",onClick:ce,class:"action-button"},{default:s(()=>[_(p(n(a)("common.add")),1)]),_:1}),l(m,{type:"default",style:{"margin-left":"8px"},onClick:_e},{default:s(()=>[l(n(W)),_(p(n(a)("expenses.importExcel")),1)]),_:1})]),_:1})])]),_:1},8,["model"])]),_:1}),l(M,{class:"table-card",bodyStyle:{padding:0}},{default:s(()=>[l($,{dataSource:G.value,columns:ie.value,loading:R.value,onChange:pe,rowKey:"id",scroll:x.value?{x:1e3}:void 0,size:x.value?"small":"default",pagination:x.value?{...b,simple:!0}:b},{bodyCell:s(({column:i,record:E})=>[i.dataIndex==="startDate"||i.dataIndex==="endDate"?(I(),P(ne,{key:0},[_(p(E[i.dataIndex]?n(Ie)(E[i.dataIndex]).format("YYYY-MM-DD"):"-"),1)],64)):i.dataIndex==="action"?(I(),se(L,{key:1,size:x.value?"small":"middle",class:"action-space"},{default:s(()=>[v("a",{onClick:le=>me(E),class:"action-link"},p(n(a)("common.edit")),9,ea),l(f,{title:n(a)("common.confirmDelete"),onConfirm:le=>ve(E),"ok-text":n(a)("common.ok"),"cancel-text":n(a)("common.cancel")},{default:s(()=>[v("a",aa,p(n(a)("common.delete")),1)]),_:2},1032,["title","onConfirm","ok-text","cancel-text"])]),_:2},1032,["size"])):A("",!0)]),_:1},8,["dataSource","columns","loading","scroll","size","pagination"])]),_:1})]),_:1}),l(te,{visible:C.value,"onUpdate:visible":e[11]||(e[11]=i=>C.value=i),title:g.value?n(a)("expenses.editExpenseItem"):n(a)("expenses.addExpenseItem"),onCancel:e[12]||(e[12]=i=>C.value=!1),onOk:fe,"confirm-loading":B.value,width:x.value?"95%":"600px"},{default:s(()=>[l(T,{model:o,layout:"vertical",ref_key:"formRef",ref:S},{default:s(()=>[l(Y,{gutter:16},{default:s(()=>[l(w,{span:12},{default:s(()=>[l(d,{label:n(a)("expenses.pid"),name:"pid",rules:[{required:!0,message:n(a)("expenses.selectPid")}]},{default:s(()=>[l(Z,{value:o.pid,"onUpdate:value":e[1]||(e[1]=i=>o.pid=i),placeholder:n(a)("expenses.selectPid"),options:H.value,loading:O.value,"show-search":"","filter-option":J,"allow-clear":"",disabled:g.value},null,8,["value","placeholder","options","loading","disabled"])]),_:1},8,["label","rules"])]),_:1}),l(w,{span:12},{default:s(()=>[l(d,{label:n(a)("expenses.item"),name:"item",rules:[{required:!0,message:"请选择费用项目"}]},{default:s(()=>[l(Z,{value:o.item,"onUpdate:value":e[2]||(e[2]=i=>o.item=i),placeholder:"请选择费用项目",options:re.value,"show-search":"","filter-option":J},null,8,["value","options"])]),_:1},8,["label"])]),_:1})]),_:1}),l(Y,{gutter:16},{default:s(()=>[l(w,{span:12},{default:s(()=>[l(d,{label:n(a)("time.startDate"),name:"startDate",rules:[{required:!0,message:n(a)("time.selectDate")}]},{default:s(()=>[l(ee,{value:o.startDate,"onUpdate:value":e[3]||(e[3]=i=>o.startDate=i),format:"YYYY-MM-DD","value-format":"YYYY-MM-DD",placeholder:n(a)("time.selectDate"),style:{width:"100%"}},null,8,["value","placeholder"])]),_:1},8,["label","rules"])]),_:1}),l(w,{span:12},{default:s(()=>[l(d,{label:n(a)("time.endDate"),name:"endDate",rules:[{required:!0,message:n(a)("time.selectDate")}]},{default:s(()=>[l(ee,{value:o.endDate,"onUpdate:value":e[4]||(e[4]=i=>o.endDate=i),format:"YYYY-MM-DD","value-format":"YYYY-MM-DD",placeholder:n(a)("time.selectDate"),style:{width:"100%"}},null,8,["value","placeholder"])]),_:1},8,["label","rules"])]),_:1})]),_:1}),l(Y,{gutter:16},{default:s(()=>[l(w,{span:8},{default:s(()=>[l(d,{label:n(a)("expenses.quantity"),name:"quantity"},{default:s(()=>[l(U,{value:o.quantity,"onUpdate:value":e[5]||(e[5]=i=>o.quantity=i),placeholder:n(a)("expenses.enterQuantity"),style:{width:"100%"},min:0},null,8,["value","placeholder"])]),_:1},8,["label"])]),_:1}),l(w,{span:8},{default:s(()=>[l(d,{label:n(a)("expenses.unitPrice"),name:"unitPrice"},{default:s(()=>[l(U,{value:o.unitPrice,"onUpdate:value":e[6]||(e[6]=i=>o.unitPrice=i),placeholder:n(a)("expenses.enterUnitPrice"),style:{width:"100%"},min:0,step:.01},null,8,["value","placeholder"])]),_:1},8,["label"])]),_:1}),l(w,{span:8},{default:s(()=>[l(d,{label:n(a)("expenses.amount"),name:"amount"},{default:s(()=>[l(U,{value:o.amount,"onUpdate:value":e[7]||(e[7]=i=>o.amount=i),placeholder:n(a)("expenses.enterAmount"),style:{width:"100%"},min:0,step:.01,disabled:""},null,8,["value","placeholder"])]),_:1},8,["label"])]),_:1})]),_:1}),l(Y,{gutter:16},{default:s(()=>[l(w,{span:8},{default:s(()=>[l(d,{label:n(a)("expenses.bankFee"),name:"bankFee"},{default:s(()=>[l(U,{value:o.bankFee,"onUpdate:value":e[8]||(e[8]=i=>o.bankFee=i),placeholder:n(a)("expenses.enterBankFee"),style:{width:"100%"},min:0,step:.01},null,8,["value","placeholder"])]),_:1},8,["label"])]),_:1}),l(w,{span:8},{default:s(()=>[l(d,{label:n(a)("expenses.subtotal"),name:"subtotal"},{default:s(()=>[l(U,{value:o.subtotal,"onUpdate:value":e[9]||(e[9]=i=>o.subtotal=i),placeholder:n(a)("expenses.autoCalculate"),style:{width:"100%"},min:0,step:.01,disabled:""},null,8,["value","placeholder"])]),_:1},8,["label"])]),_:1})]),_:1}),l(d,{label:n(a)("expenses.remark"),name:"remark"},{default:s(()=>[l(De,{value:o.remark,"onUpdate:value":e[10]||(e[10]=i=>o.remark=i),placeholder:n(a)("expenses.enterRemark"),rows:2},null,8,["value","placeholder"])]),_:1},8,["label"]),l(d,{label:n(a)("common.upload")},{default:s(()=>[y.value.length>0?(I(),P("div",ta,[(I(!0),P(ne,null,Je(y.value,(i,E)=>(I(),P("div",{key:i.uuid,class:"file-preview"},[v("div",la,[v("span",null,p(i.fileName),1),l(m,{type:"link",onClick:le=>ge(E),size:"small"},{default:s(()=>[_(p(n(a)("common.delete")),1)]),_:2},1032,["onClick"])]),he(i.fileName)?(I(),P("div",sa,[v("img",{src:i.url,alt:i.fileName,referrerpolicy:"no-referrer",style:{"max-width":"200px","max-height":"200px"}},null,8,na)])):A("",!0)]))),128))])):A("",!0),l(ae,{"before-upload":be,customRequest:X,"file-list":h.value,"show-upload-list":!1,multiple:""},{default:s(()=>[l(m,null,{default:s(()=>[l(n(W)),_(" "+p(n(a)("expenses.clickToUpload")),1)]),_:1})]),_:1},8,["file-list"])]),_:1},8,["label"])]),_:1},8,["model"])]),_:1},8,["visible","title","confirm-loading","width"]),l(te,{visible:q.value,"onUpdate:visible":e[14]||(e[14]=i=>q.value=i),title:n(a)("expenses.batchImport"),onCancel:e[15]||(e[15]=i=>q.value=!1),footer:null,width:x.value?"95%":"500px"},{default:s(()=>[v("div",oa,[l(ae,{"before-upload":xe,customRequest:X,"file-list":h.value,"show-upload-list":!0,accept:".xlsx,.xls"},{default:s(()=>[l(m,null,{default:s(()=>[l(n(W)),_(" "+p(n(a)("expenses.selectExcelFile")),1)]),_:1})]),_:1},8,["file-list"]),l(m,{type:"link",onClick:we,style:{display:"block",margin:"10px auto",padding:"0"}},{default:s(()=>[_(p(n(a)("expenses.downloadTemplate")),1)]),_:1}),v("div",ia,[v("p",null,p(n(a)("expenses.supportedFormats")),1),v("p",null,p(n(a)("expenses.fileSizeLimit")),1)]),v("div",ra,[l(m,{onClick:e[13]||(e[13]=i=>q.value=!1)},{default:s(()=>[_(p(n(a)("common.cancel")),1)]),_:1}),l(m,{type:"primary",onClick:ye,loading:N.value,disabled:h.value.length===0,style:{"margin-left":"8px"}},{default:s(()=>[_(p(n(a)("expenses.import")),1)]),_:1},8,["loading","disabled"])])])]),_:1},8,["visible","title","width"])]),_:1})}}},Na=qe(da,[["__scopeId","data-v-0bfaeaa6"]]);export{Na as default};
