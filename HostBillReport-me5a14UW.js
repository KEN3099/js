import{a as T,r as u,q as me,l as pe,z as ue,a9 as S,aa as n,o as _,c as l,e as g,u as s,N as x,ad as f,b as k,ab as V,F as E,a4 as j,K as R}from"./@vue-C4NowhOt.js";import{u as fe}from"./vue-i18n-DLYs8-Ps.js";import{a as F}from"./axios-NIGUFBhG.js";import{d as H}from"./dayjs-CflfeGVC.js";import{_ as ve}from"./index-CeZUq1ge.js";import{h as d,d as _e,f as ge,C as he,F as be,n as ye,D as we,B as xe,j as ke,T as Fe,o as Ce,g as Ie,I as Me,w as Ye}from"./ant-design-vue-A2bDz-ar.js";import"./@intlify-ZcBRI--x.js";import"./pinia-9OtbBE5K.js";import"./vue-router-PaDTG1U4.js";import"./@ant-design-BGOLSkC9.js";import"./@ctrl-DOFZgDuz.js";import"./element-plus-Mh0yyZIL.js";import"./lodash-es-wgX17T5E.js";import"./@vueuse-BBvwCcyR.js";import"./@element-plus-DaL4F972.js";import"./@popperjs-DB1lLFnh.js";import"./async-validator-CRx4dHSJ.js";import"./memoize-one-BdPwpGay.js";import"./normalize-wheel-es-BQoi3Ox2.js";import"./@floating-ui-DnZj_KkR.js";import"./@babel-Bq4_u9L9.js";import"./resize-observer-polyfill-B1PUzC5B.js";import"./@emotion-BtrR-yrm.js";import"./stylis-DsJDcYJc.js";import"./scroll-into-view-if-needed-SxpMpKWN.js";import"./compute-scroll-into-view-1gs_hJI2.js";import"./vue-types-99Xd1yP8.js";import"./dom-align-CRCehRfe.js";import"./throttle-debounce-CUWDS_la.js";const ze={class:"form-fields"},Te={class:"form-actions"},Se=["onClick"],Ee=["onClick"],Re={key:1,class:"action-link-disabled"},Ue=["title"],De=["src"],Pe={__name:"HostBillReport",setup(qe){const{t:a}=fe(),v=T({periodFrom:null,periodTo:null}),O="/api/host/";F.defaults.baseURL=O;const U=u([]),h=u(!1),r=u(!1),c=T({current:1,pageSize:10,total:0,showSizeChanger:!0,pageSizeOptions:["10","20","50","100"]}),m=u(!1),C=u(!1),Y=u(!1),$=u(null),p=T({email:"",remark:""}),A=me(()=>[{title:a("fields.period"),dataIndex:"period",width:r.value?80:120},{title:a("fields.incomeAmount"),dataIndex:"grandTotal",width:r.value?80:120},{title:a("fields.createdAt"),dataIndex:"gentime",width:r.value?120:180},{title:a("fields.action"),dataIndex:"action",width:r.value?150:200,fixed:r.value?void 0:"right"}]),I=u(!1),w=u(""),D=()=>{w.value&&(window.URL.revokeObjectURL(w.value),w.value=""),I.value=!1,m.value=!1},K=()=>{m.value=!m.value},z=()=>{r.value=window.innerWidth<=768},G=o=>({0:a("status.pendingGenerate"),1:a("status.generated"),2:a("status.settled")})[o]||a("status.unknown"),Q=o=>({0:"default",1:"processing",2:"success"})[o]||"default",W=o=>o?H(o).format("YYYY-MM-DD HH:mm:ss"):"-",P=o=>o&&o>H().endOf("month"),M=async()=>{try{h.value=!0;const o={page:c.current,size:c.pageSize,...v};o.periodFrom&&(o.periodFrom=o.periodFrom.format("YYYY-MM")),o.periodTo&&(o.periodTo=o.periodTo.format("YYYY-MM"));const e=await F.post("/host/report/bill/query",o);e.data.code==200?(U.value=e.data.data.records||e.data.data||[],c.total=e.data.data.total||0):d.error(e.data.message||a("common.queryFailed"))}catch(o){console.error("æŸ¥è¯¢å¤±è´¥:",o),d.error(a("common.queryFailed")+": "+o.message)}finally{h.value=!1}},J=()=>{c.current=1,M()},X=()=>{v.periodFrom=null,v.periodTo=null,c.current=1,M()},Z=o=>{c.current=o.current,c.pageSize=o.pageSize,M()},ee=async()=>{if(!p.email){d.warning(a("common.emailRequired"));return}if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(p.email)){d.warning(a("common.emailInvalid"));return}try{Y.value=!0;const e={billId:$.value.id,email:p.email,remark:p.remark},i=await F.post("/host/report/bill/sendEmail",e);i.data.code==200?(d.success(a("common.sendEmailSuccess")),C.value=!1):d.error(i.data.message||a("common.sendEmailFailed"))}catch(e){console.error("å‘é€é‚®ä»¶å¤±è´¥:",e),d.error(a("common.sendEmailFailed")+": "+(e.response?.data?.message||e.message))}finally{Y.value=!1}},ae=async o=>{try{h.value=!0;const e={billId:o.id},i=await F.get("/host/report/bill/generate",{params:e});if(i.data.code==200){const b=i.data.data;w.value=b,I.value=!0}else d.error(i.data.message||a("common.getPDFFailed"))}catch(e){console.error("èŽ·å–PDFå¤±è´¥:",e),d.error(a("common.getPDFFailed")+": "+(e.response?.data?.message||e.message))}finally{h.value=!1}},oe=async o=>{try{h.value=!0;const e={billId:o.id},i=await F.post("/host/report/bill/send2Email",e);i.data.code==200?d.success(a("common.success")):d.error(i.data.message||a("common.downloadFailed"))}catch(e){console.error("ä¸‹è½½å¤±è´¥:",e),d.error(a("common.downloadFailed")+": "+(e.response?.data?.message||e.message))}finally{h.value=!1}};return pe(()=>{z(),M(),window.addEventListener("resize",z)}),ue(()=>{window.removeEventListener("resize",z)}),(o,e)=>{const i=we,b=ye,q=xe,B=be,N=he,te=Fe,le=Ce,se=ke,ne=ge,L=Ie,re=Me,ie=Ye,de=_e;return _(),S(de,{class:"billing-report-page"},{default:n(()=>[l(ne,{class:"content"},{default:n(()=>[l(N,{class:"query-card"},{default:n(()=>[l(B,{model:v,layout:"inline",class:"query-form"},{default:n(()=>[g("div",ze,[l(b,{label:s(a)("fields.periodFrom"),class:"form-item"},{default:n(()=>[l(i,{value:v.periodFrom,"onUpdate:value":e[0]||(e[0]=t=>v.periodFrom=t),picker:"month",format:"YYYY-MM",placeholder:s(a)("fields.selectPeriodFrom"),class:"responsive-date-picker","disabled-date":P,"get-popup-container":t=>t.parentNode},null,8,["value","placeholder","get-popup-container"])]),_:1},8,["label"]),l(b,{label:s(a)("fields.periodTo"),class:"form-item"},{default:n(()=>[l(i,{value:v.periodTo,"onUpdate:value":e[1]||(e[1]=t=>v.periodTo=t),picker:"month",format:"YYYY-MM",placeholder:s(a)("fields.selectPeriodTo"),class:"responsive-date-picker","disabled-date":P,"get-popup-container":t=>t.parentNode},null,8,["value","placeholder","get-popup-container"])]),_:1},8,["label"])]),g("div",Te,[l(b,{class:"action-buttons"},{default:n(()=>[l(q,{type:"primary",onClick:J,class:"action-button"},{default:n(()=>[x(f(s(a)("common.search")),1)]),_:1}),l(q,{style:{"margin-left":"8px"},onClick:X,class:"action-button"},{default:n(()=>[x(f(s(a)("common.reset")),1)]),_:1})]),_:1})])]),_:1},8,["model"])]),_:1}),l(N,{class:"table-card",bodyStyle:{padding:0}},{default:n(()=>[l(se,{dataSource:U.value,columns:A.value,loading:h.value,onChange:Z,rowKey:"id",scroll:r.value?{x:400}:{x:1e3},size:r.value?"small":"default",pagination:r.value?{...c,simple:!0}:c},{bodyCell:n(({column:t,record:y})=>[t.dataIndex==="status"?(_(),S(te,{key:0,color:Q(y.status),class:"status-tag"},{default:n(()=>[x(f(G(y.status)),1)]),_:2},1032,["color"])):t.dataIndex==="gentime"||t.dataIndex==="uptime"?(_(),k(E,{key:1},[x(f(W(y[t.dataIndex])),1)],64)):t.dataIndex==="grandTotal"?(_(),k(E,{key:2},[x(f(y[t.dataIndex]),1)],64)):t.dataIndex==="action"?(_(),k(E,{key:3},[y.pdfFile?(_(),S(le,{key:0,size:r.value?"small":"middle",class:"action-space"},{default:n(()=>[g("a",{onClick:ce=>ae(y),class:"pdf-link"},f(s(a)("common.preview"))+"/"+f(s(a)("common.download")),9,Se),g("a",{onClick:ce=>oe(y),class:"action-link",style:{color:"#52c41a"}},f(s(a)("common.sendToEmail")),9,Ee)]),_:2},1032,["size"])):(_(),k("span",Re,"-"))],64)):V("",!0)]),_:1},8,["dataSource","columns","loading","scroll","size","pagination"])]),_:1})]),_:1}),l(L,{visible:I.value,"onUpdate:visible":e[3]||(e[3]=t=>I.value=t),title:s(a)("common.preview"),onCancel:D,footer:null,width:r.value?"95%":m.value?"100%":"80%",wrapClassName:m.value?"pdf-preview-modal fullscreen":"pdf-preview-modal",style:j(m.value?{position:"fixed",top:0,left:0,width:"100%",height:"100%",margin:0,padding:0}:{}),closable:!1},{default:n(()=>[g("div",{style:{display:"flex","align-items":"center",position:"absolute",right:"20px",top:"15px","z-index":"1000"},onClick:e[2]||(e[2]=R(()=>{},["stop"]))},[g("button",{onClick:R(K,["stop"]),style:{"margin-right":"15px",background:"#1890ff",border:"none",cursor:"pointer",color:"white","font-size":"16px",width:"32px",height:"32px","border-radius":"4px",display:"flex","align-items":"center","justify-content":"center","font-weight":"bold",outline:"none"},title:m.value?s(a)("fullscreen.exit"):s(a)("fullscreen.enter")},f(m.value?"ðŸ——":"â›¶"),9,Ue),g("span",{onClick:R(D,["stop"]),style:{cursor:"pointer","font-size":"32px",color:"#000000",display:"flex","align-items":"center","justify-content":"center",width:"32px",height:"32px",outline:"none","box-shadow":"none"}},"Ã—")]),w.value?(_(),k("div",{key:0,class:"pdf-container",style:j(m.value?{height:"calc(100vh - 40px)"}:{height:"70vh"})},[g("iframe",{src:w.value,class:"pdf-iframe"},null,8,De)],4)):V("",!0)]),_:1},8,["visible","title","width","wrapClassName","style"]),l(L,{visible:C.value,"onUpdate:visible":e[6]||(e[6]=t=>C.value=t),title:s(a)("common.sendToEmail"),onCancel:e[7]||(e[7]=t=>C.value=!1),"confirm-loading":Y.value,onOk:ee,width:r.value?"95%":"500px"},{default:n(()=>[l(B,{model:p,layout:"vertical"},{default:n(()=>[l(b,{label:s(a)("common.email"),name:"email",rules:[{required:!0,message:s(a)("common.emailRequired")},{type:"email",message:s(a)("common.emailInvalid")}]},{default:n(()=>[l(re,{value:p.email,"onUpdate:value":e[4]||(e[4]=t=>p.email=t),placeholder:s(a)("common.enterEmail")},null,8,["value","placeholder"])]),_:1},8,["label","rules"]),l(b,{label:s(a)("common.remark"),name:"remark"},{default:n(()=>[l(ie,{value:p.remark,"onUpdate:value":e[5]||(e[5]=t=>p.remark=t),placeholder:s(a)("common.enterRemark"),rows:3},null,8,["value","placeholder"])]),_:1},8,["label"])]),_:1},8,["model"])]),_:1},8,["visible","title","confirm-loading","width"])]),_:1})}}},ua=ve(Pe,[["__scopeId","data-v-48c490bf"]]);export{ua as default};
