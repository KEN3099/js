import{a1 as I,r as p,a as Q,f as Ce,w as qe,o as Ee,k as Ue,W as ne,X as s,_ as r,a0 as C,l,a3 as f,u as n,I as b,$ as c,Y,a2 as A,F as oe,Z as Me}from"./vendor-2pDcVUmr.js";import{_ as Pe,u as Ye,a as d,U as K,d as Se}from"./index-Cfob8AIV.js";import"./antv-CEsH_Ukj.js";const ze={class:"form-fields"},Le={class:"form-actions"},Re=["onClick"],Oe={class:"action-link"},Ve={key:0,class:"files-preview"},Ne={class:"file-info"},Te={key:0,class:"image-preview"},$e=["src","alt"],je={class:"import-container"},Be={class:"import-tips"},We={class:"modal-footer"},Qe={__name:"Expenses",setup(Ae){const{t:a}=Ye(),X="/api/host/";I.defaults.baseURL=X;const S=p(),D=Q({pid:null,startDate:null,endDate:null}),Z=p([]),O=p(!1),_=p(!1),h=Q({current:1,pageSize:10,total:0,showSizeChanger:!0,pageSizeOptions:["10","20","50","100"]}),G=p([]),ie=p([]),V=p(!1),de=Ce(()=>{const t=[{title:a("expenses.pid"),dataIndex:"pid",width:100},{title:a("expenses.item"),dataIndex:"item",width:150},{title:a("time.startDate"),dataIndex:"startDate",width:120},{title:a("time.endDate"),dataIndex:"endDate",width:120},{title:a("expenses.quantity"),dataIndex:"quantity",width:100},{title:a("expenses.unitPrice"),dataIndex:"unitPrice",width:100},{title:a("expenses.amount"),dataIndex:"amount",width:100},{title:a("expenses.bankFee"),dataIndex:"bankFee",width:100},{title:a("expenses.subtotal"),dataIndex:"subtotal",width:100},{title:a("expenses.actions"),dataIndex:"action",width:120,fixed:_.value?void 0:"right"}];return _.value?t.filter(e=>e.dataIndex==="pid"||e.dataIndex==="item"||e.dataIndex==="amount"||e.dataIndex==="action").map(e=>e.dataIndex==="pid"?{...e,width:80}:e.dataIndex==="item"?{...e,width:100}:e.dataIndex==="amount"?{...e,width:80}:e.dataIndex==="action"?{...e,width:80}:e):t}),q=p(!1),N=p(!1),y=p(!1),z=p(null),o=Q({pid:void 0,item:void 0,summary:"",startDate:null,endDate:null,quantity:void 0,unitPrice:void 0,amount:void 0,bankFee:void 0,subtotal:void 0,remark:""}),re=p([{label:"固定資産税",value:"固定資産税"},{label:"管理修繕費",value:"管理修繕費"},{label:"不動産取得税",value:"不動産取得税"},{label:"逾期款項代繳",value:"逾期款項代繳"},{label:"町會費",value:"町會費"},{label:"保險費用",value:"保險費用"},{label:"代辨费用",value:"代辨费用"},{label:"牌照使用费",value:"牌照使用费"},{label:"牌照辦理費用",value:"牌照辦理費用"},{label:"消防點檢費用",value:"消防點檢費用"},{label:"摄影費用",value:"摄影費用"},{label:"採購費用",value:"採購費用"},{label:"軟装相關費用",value:"軟装相關費用"},{label:"維修費用",value:"維修費用"},{label:"解約费用",value:"解約费用"},{label:"預存費用",value:"預存費用"},{label:"調整费用",value:"調整费用"}]),g=p([]),w=p([]),E=p(!1),T=p(!1),H=(t,e)=>e.label.toLowerCase().indexOf(t.toLowerCase())>=0;qe(()=>[o.quantity,o.unitPrice,o.bankFee],()=>{o.quantity!==void 0&&o.unitPrice!==void 0?o.amount=parseFloat((o.quantity*o.unitPrice).toFixed(2)):o.amount=void 0,o.amount!==void 0&&o.bankFee!==void 0?o.subtotal=parseFloat((o.amount+o.bankFee).toFixed(2)):o.amount!==void 0?o.subtotal=o.amount:o.subtotal=void 0});const $=()=>{_.value=window.innerWidth<=768},j=async()=>{try{V.value=!0;const t=await I.get("/admin/settlementReport/getPidList");if(t.data.code==200){const e=t.data.data.map(m=>({label:m.pid,value:m.id}));G.value=e,ie.value=e}else d.error(t.data.message||a("common.queryFailed"))}catch(t){console.error("获取PID列表失败:",t),d.error(a("common.queryFailed")+": "+t.message)}finally{V.value=!1}},k=async()=>{try{O.value=!0;const t={page:h.current,size:h.pageSize,...D},e=await I.post("/admin/settlementReport/queryExpensesList",t);e.data.code==200?(Z.value=e.data.data.records||e.data.data||[],h.total=e.data.data.total||0):d.error(e.data.message||a("common.queryFailed"))}catch(t){console.error("查询失败:",t),d.error(a("common.queryFailed")+": "+t.message)}finally{O.value=!1}},ue=()=>{h.current=1,k()},pe=()=>{D.pid=void 0,D.startDate=null,D.endDate=null,h.current=1,k()},ce=t=>{h.current=t.current,h.pageSize=t.pageSize,k()},me=()=>{y.value=!1,z.value=null,Object.keys(o).forEach(t=>{o[t]=t==="quantity"||t==="unitPrice"||t==="amount"||t==="bankFee"||t==="subtotal"?void 0:""}),g.value=[],w.value=[],q.value=!0,S.value?.clearValidate(),j()},ve=t=>{y.value=!0,z.value=t.id,Object.keys(o).forEach(e=>{o[e]=t[e]!==null&&t[e]!==void 0?t[e]:e==="quantity"||e==="unitPrice"||e==="amount"||e==="bankFee"||e==="subtotal"||e==="pid"?void 0:""}),t.attachment?w.value=t.files||[]:w.value=[],g.value=[],q.value=!0,S.value?.clearValidate(),j()},fe=async t=>{try{const e=await I.post("/admin/settlementReport/deleteExpense",{id:t.id});e.data.code==200?(d.success(a("success.deleteSuccess")),k()):d.error(e.data.message||a("error.deleteFailed"))}catch(e){console.error("删除失败:",e),d.error(a("error.deleteFailed")+": "+e.message)}},xe=async()=>{try{await S.value.validateFields(),N.value=!0;const t={...o};y.value&&z.value&&(t.id=z.value),w.value.length>0&&(t.attachment=w.value.map(m=>m.uuid).join(","));const e=await I.post("/admin/settlementReport/saveExpenses",t);e.data.code==200?(d.success(y.value?a("success.updateSuccess"):a("success.createSuccess")),q.value=!1,k()):d.error(e.data.message||(y.value?a("error.updateFailed"):a("error.createFailed")))}catch(t){console.error(y.value?"编辑失败:":"新增失败:",t),t.errorFields||d.error(y.value?a("error.updateFailed")+": "+t.message:a("error.createFailed")+": "+t.message)}finally{N.value=!1}},be=()=>{E.value=!0,g.value=[]},_e=t=>t.type==="application/vnd.ms-excel"||t.type==="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"||t.name.endsWith(".xlsx")||t.name.endsWith(".xls")?t.size/1024/1024<10?!0:(d.error(a("expenses.fileSizeExceed")),!1):(d.error(a("expenses.onlyExcelFiles")),!1),he=t=>{const e=t.size/1024/1024<2;return e||d.error(a("expenses.fileSizeExceed2M")),e},J=async t=>{const{file:e,onSuccess:m,onError:u,onProgress:v}=t;if(e.type==="application/vnd.ms-excel"||e.type==="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"||e.name.endsWith(".xlsx")||e.name.endsWith(".xls"))g.value=[e],m();else{const M=new FormData;M.append("file",e);try{const x=await I.post("/admin/settlementReport/upload",M,{headers:{"Content-Type":"multipart/form-data"},onUploadProgress:L=>{const W=Math.round(L.loaded*100/L.total);v({percent:W},e)}});x.data.code==200?(w.value.push(x.data.data),m(x.data,e),d.success(a("expenses.uploadSuccess"))):(u(new Error(x.data.message||a("expenses.uploadFailed"))),d.error(x.data.message||a("expenses.uploadFailed")))}catch(x){u(x),d.error(a("expenses.uploadFailed")+": "+(x.response?.data?.message||x.message))}}},ye=t=>{w.value.splice(t,1)},ge=t=>{const e=["jpg","jpeg","png","gif","bmp","webp"],m=t.split(".").pop().toLowerCase();return e.includes(m)},we=async()=>{if(g.value.length===0){d.warning(a("expenses.selectFileFirst"));return}try{T.value=!0;const t=new FormData;t.append("file",g.value[0]);const e=await I.post("/admin/settlementReport/uploadExcel",t,{headers:{"Content-Type":"multipart/form-data"}});e.data.code==200?(d.success(a("expenses.importSuccess")),E.value=!1,k()):d.error(e.data.message||a("expenses.importFailed"))}catch(t){console.error("导入失败:",t),d.error(a("expenses.importFailed")+": "+(t.response?.data?.message||t.message))}finally{T.value=!1}},Fe=()=>{window.open(X+"/template.xlsx","_blank")};return Ee(()=>{$(),k(),j(),window.addEventListener("resize",$)}),Ue(()=>{window.removeEventListener("resize",$)}),(t,e)=>{const m=r("a-input"),u=r("a-form-item"),v=r("a-button"),B=r("a-form"),M=r("a-card"),x=r("a-popconfirm"),L=r("a-space"),W=r("a-table"),De=r("a-layout-content"),ee=r("a-select"),F=r("a-col"),R=r("a-row"),ae=r("a-date-picker"),P=r("a-input-number"),ke=r("a-textarea"),te=r("a-upload"),le=r("a-modal"),Ie=r("a-layout");return C(),ne(Ie,{class:"expenses-management-page"},{default:s(()=>[l(De,{class:"content"},{default:s(()=>[l(M,{class:"query-card"},{default:s(()=>[l(B,{model:D,layout:"inline",class:"query-form"},{default:s(()=>[f("div",ze,[l(u,{label:n(a)("expenses.pid"),class:"form-item"},{default:s(()=>[l(m,{value:D.pid,"onUpdate:value":e[0]||(e[0]=i=>D.pid=i),placeholder:n(a)("expenses.enterPid"),class:"responsive-input",style:{width:"150px"}},null,8,["value","placeholder"])]),_:1},8,["label"])]),f("div",Le,[l(u,{class:"action-buttons"},{default:s(()=>[l(v,{type:"primary",onClick:ue,class:"action-button"},{default:s(()=>[b(c(n(a)("common.search")),1)]),_:1}),l(v,{style:{"margin-left":"8px"},onClick:pe,class:"action-button"},{default:s(()=>[b(c(n(a)("common.reset")),1)]),_:1}),l(v,{style:{"margin-left":"8px"},type:"primary",onClick:me,class:"action-button"},{default:s(()=>[b(c(n(a)("common.add")),1)]),_:1}),l(v,{type:"default",style:{"margin-left":"8px"},onClick:be},{default:s(()=>[l(n(K)),b(c(n(a)("expenses.importExcel")),1)]),_:1})]),_:1})])]),_:1},8,["model"])]),_:1}),l(M,{class:"table-card",bodyStyle:{padding:0}},{default:s(()=>[l(W,{dataSource:Z.value,columns:de.value,loading:O.value,onChange:ce,rowKey:"id",scroll:_.value?{x:1e3}:void 0,size:_.value?"small":"default",pagination:_.value?{...h,simple:!0}:h},{bodyCell:s(({column:i,record:U})=>[i.dataIndex==="startDate"||i.dataIndex==="endDate"?(C(),Y(oe,{key:0},[b(c(U[i.dataIndex]?n(Se)(U[i.dataIndex]).format("YYYY-MM-DD"):"-"),1)],64)):i.dataIndex==="action"?(C(),ne(L,{key:1,size:_.value?"small":"middle",class:"action-space"},{default:s(()=>[f("a",{onClick:se=>ve(U),class:"action-link"},c(n(a)("common.edit")),9,Re),l(x,{title:n(a)("common.confirmDelete"),onConfirm:se=>fe(U),"ok-text":n(a)("common.ok"),"cancel-text":n(a)("common.cancel")},{default:s(()=>[f("a",Oe,c(n(a)("common.delete")),1)]),_:2},1032,["title","onConfirm","ok-text","cancel-text"])]),_:2},1032,["size"])):A("",!0)]),_:1},8,["dataSource","columns","loading","scroll","size","pagination"])]),_:1})]),_:1}),l(le,{visible:q.value,"onUpdate:visible":e[11]||(e[11]=i=>q.value=i),title:y.value?n(a)("expenses.editExpenseItem"):n(a)("expenses.addExpenseItem"),onCancel:e[12]||(e[12]=i=>q.value=!1),onOk:xe,"confirm-loading":N.value,width:_.value?"95%":"600px"},{default:s(()=>[l(B,{model:o,layout:"vertical",ref_key:"formRef",ref:S},{default:s(()=>[l(R,{gutter:16},{default:s(()=>[l(F,{span:12},{default:s(()=>[l(u,{label:n(a)("expenses.pid"),name:"pid",rules:[{required:!0,message:n(a)("expenses.selectPid")}]},{default:s(()=>[l(ee,{value:o.pid,"onUpdate:value":e[1]||(e[1]=i=>o.pid=i),placeholder:n(a)("expenses.selectPid"),options:G.value,loading:V.value,"show-search":"","filter-option":H,"allow-clear":"",disabled:y.value},null,8,["value","placeholder","options","loading","disabled"])]),_:1},8,["label","rules"])]),_:1}),l(F,{span:12},{default:s(()=>[l(u,{label:n(a)("expenses.item"),name:"item",rules:[{required:!0,message:"请选择费用项目"}]},{default:s(()=>[l(ee,{value:o.item,"onUpdate:value":e[2]||(e[2]=i=>o.item=i),placeholder:"请选择费用项目",options:re.value,"show-search":"","filter-option":H},null,8,["value","options"])]),_:1},8,["label"])]),_:1})]),_:1}),l(R,{gutter:16},{default:s(()=>[l(F,{span:12},{default:s(()=>[l(u,{label:n(a)("time.startDate"),name:"startDate",rules:[{required:!0,message:n(a)("time.selectDate")}]},{default:s(()=>[l(ae,{value:o.startDate,"onUpdate:value":e[3]||(e[3]=i=>o.startDate=i),format:"YYYY-MM-DD","value-format":"YYYY-MM-DD",placeholder:n(a)("time.selectDate"),style:{width:"100%"}},null,8,["value","placeholder"])]),_:1},8,["label","rules"])]),_:1}),l(F,{span:12},{default:s(()=>[l(u,{label:n(a)("time.endDate"),name:"endDate",rules:[{required:!0,message:n(a)("time.selectDate")}]},{default:s(()=>[l(ae,{value:o.endDate,"onUpdate:value":e[4]||(e[4]=i=>o.endDate=i),format:"YYYY-MM-DD","value-format":"YYYY-MM-DD",placeholder:n(a)("time.selectDate"),style:{width:"100%"}},null,8,["value","placeholder"])]),_:1},8,["label","rules"])]),_:1})]),_:1}),l(R,{gutter:16},{default:s(()=>[l(F,{span:8},{default:s(()=>[l(u,{label:n(a)("expenses.quantity"),name:"quantity"},{default:s(()=>[l(P,{value:o.quantity,"onUpdate:value":e[5]||(e[5]=i=>o.quantity=i),placeholder:n(a)("expenses.enterQuantity"),style:{width:"100%"},min:0},null,8,["value","placeholder"])]),_:1},8,["label"])]),_:1}),l(F,{span:8},{default:s(()=>[l(u,{label:n(a)("expenses.unitPrice"),name:"unitPrice"},{default:s(()=>[l(P,{value:o.unitPrice,"onUpdate:value":e[6]||(e[6]=i=>o.unitPrice=i),placeholder:n(a)("expenses.enterUnitPrice"),style:{width:"100%"},min:0,step:.01},null,8,["value","placeholder"])]),_:1},8,["label"])]),_:1}),l(F,{span:8},{default:s(()=>[l(u,{label:n(a)("expenses.amount"),name:"amount"},{default:s(()=>[l(P,{value:o.amount,"onUpdate:value":e[7]||(e[7]=i=>o.amount=i),placeholder:n(a)("expenses.enterAmount"),style:{width:"100%"},min:0,step:.01,disabled:""},null,8,["value","placeholder"])]),_:1},8,["label"])]),_:1})]),_:1}),l(R,{gutter:16},{default:s(()=>[l(F,{span:8},{default:s(()=>[l(u,{label:n(a)("expenses.bankFee"),name:"bankFee"},{default:s(()=>[l(P,{value:o.bankFee,"onUpdate:value":e[8]||(e[8]=i=>o.bankFee=i),placeholder:n(a)("expenses.enterBankFee"),style:{width:"100%"},min:0,step:.01},null,8,["value","placeholder"])]),_:1},8,["label"])]),_:1}),l(F,{span:8},{default:s(()=>[l(u,{label:n(a)("expenses.subtotal"),name:"subtotal"},{default:s(()=>[l(P,{value:o.subtotal,"onUpdate:value":e[9]||(e[9]=i=>o.subtotal=i),placeholder:n(a)("expenses.autoCalculate"),style:{width:"100%"},min:0,step:.01,disabled:""},null,8,["value","placeholder"])]),_:1},8,["label"])]),_:1})]),_:1}),l(u,{label:n(a)("expenses.remark"),name:"remark"},{default:s(()=>[l(ke,{value:o.remark,"onUpdate:value":e[10]||(e[10]=i=>o.remark=i),placeholder:n(a)("expenses.enterRemark"),rows:2},null,8,["value","placeholder"])]),_:1},8,["label"]),l(u,{label:n(a)("common.upload")},{default:s(()=>[w.value.length>0?(C(),Y("div",Ve,[(C(!0),Y(oe,null,Me(w.value,(i,U)=>(C(),Y("div",{key:i.uuid,class:"file-preview"},[f("div",Ne,[f("span",null,c(i.fileName),1),l(v,{type:"link",onClick:se=>ye(U),size:"small"},{default:s(()=>[b(c(n(a)("common.delete")),1)]),_:2},1032,["onClick"])]),ge(i.fileName)?(C(),Y("div",Te,[f("img",{src:i.url,alt:i.fileName,referrerpolicy:"no-referrer",style:{"max-width":"200px","max-height":"200px"}},null,8,$e)])):A("",!0)]))),128))])):A("",!0),l(te,{"before-upload":he,customRequest:J,"file-list":g.value,"show-upload-list":!1,multiple:""},{default:s(()=>[l(v,null,{default:s(()=>[l(n(K)),b(" "+c(n(a)("expenses.clickToUpload")),1)]),_:1})]),_:1},8,["file-list"])]),_:1},8,["label"])]),_:1},8,["model"])]),_:1},8,["visible","title","confirm-loading","width"]),l(le,{visible:E.value,"onUpdate:visible":e[14]||(e[14]=i=>E.value=i),title:n(a)("expenses.batchImport"),onCancel:e[15]||(e[15]=i=>E.value=!1),footer:null,width:_.value?"95%":"500px"},{default:s(()=>[f("div",je,[l(te,{"before-upload":_e,customRequest:J,"file-list":g.value,"show-upload-list":!0,accept:".xlsx,.xls"},{default:s(()=>[l(v,null,{default:s(()=>[l(n(K)),b(" "+c(n(a)("expenses.selectExcelFile")),1)]),_:1})]),_:1},8,["file-list"]),l(v,{type:"link",onClick:Fe,style:{display:"block",margin:"10px auto",padding:"0"}},{default:s(()=>[b(c(n(a)("expenses.downloadTemplate")),1)]),_:1}),f("div",Be,[f("p",null,c(n(a)("expenses.supportedFormats")),1),f("p",null,c(n(a)("expenses.fileSizeLimit")),1)]),f("div",We,[l(v,{onClick:e[13]||(e[13]=i=>E.value=!1)},{default:s(()=>[b(c(n(a)("common.cancel")),1)]),_:1}),l(v,{type:"primary",onClick:we,loading:T.value,disabled:g.value.length===0,style:{"margin-left":"8px"}},{default:s(()=>[b(c(n(a)("expenses.import")),1)]),_:1},8,["loading","disabled"])])])]),_:1},8,["visible","title","width"])]),_:1})}}},Ge=Pe(Qe,[["__scopeId","data-v-288420f6"]]);export{Ge as default};
